<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPACShortModel</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e2e8f0;
        --card: #ffffff;
        --chip: #f1f5f9;
        --danger: #b91c1c;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 28px;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: var(--bg);
      }

      h1 {
        margin: 0 0 8px 0;
        font-size: 56px;
        letter-spacing: -0.02em;
      }

      .subhead {
        color: var(--muted);
        margin: 0 0 22px 0;
        font-size: 18px;
      }

      .grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 18px;
        align-items: start;
      }

      @media (max-width: 980px) {
        .grid { grid-template-columns: 1fr; }
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 18px;
      }

      .card h2 {
        margin: 0 0 12px 0;
        font-size: 26px;
        letter-spacing: -0.01em;
      }

      .table-wrap { overflow-x: auto; }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }

      th, td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 16px;
        vertical-align: middle;
        white-space: nowrap;
      }

      th {
        color: #475569;
        font-weight: 600;
      }

      tr.data-row:hover {
        background: #fafafa;
        cursor: pointer;
      }

      .chip {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--chip);
        border: 1px solid var(--border);
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.01em;
      }

      .muted { color: var(--muted); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .error { color: var(--danger); margin-top: 10px; white-space: pre-wrap; }

      .details {
        margin-top: 14px;
        border-top: 1px solid var(--border);
        padding-top: 14px;
      }

      .details label {
        display: block;
        color: var(--muted);
        margin-bottom: 8px;
      }

      select {
        width: 100%;
        padding: 12px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        font-size: 16px;
      }

      pre {
        margin: 12px 0 0 0;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fafafa;
        overflow: auto;
        max-height: 360px;
        font-size: 13px;
        line-height: 1.45;
      }

      .footer {
        margin-top: 18px;
        padding-top: 14px;
        border-top: 1px solid var(--border);
        color: var(--muted);
      }

      .defs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 18px;
        margin-top: 10px;
      }

      @media (max-width: 700px) {
        .defs { grid-template-columns: 1fr; }
        table { min-width: 960px; }
      }

      .def-item b {
        color: var(--text);
      }

      .small {
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <h1>SPACShortModel</h1>
    <p class="subhead" id="subhead">Loading…</p>

    <div class="grid">
      <section class="card">
        <h2>Latest state</h2>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Bucket</th>
                <th>State</th>
                <th>As of</th>
                <th>Demand/Margin</th>
                <th>Cost/Capex</th>
                <th>Persistence</th>
                <th>Strategic initiatives</th>
                <th>In scope</th>
              </tr>
            </thead>
            <tbody id="latestBody"></tbody>
          </table>
        </div>

        <div class="details">
          <label for="tickerSelect">Click a row or pick a ticker to view <span class="mono">details_json</span>.</label>
          <select id="tickerSelect">
            <option value="">Select a ticker…</option>
          </select>
          <pre id="detailsPre" class="mono muted">No ticker selected.</pre>
        </div>

        <div class="footer">
          <div class="small"><b>Condition definitions</b></div>
          <div class="defs small">
            <div class="def-item"><b>C1:</b> Demand/Margin</div>
            <div class="def-item"><b>C2:</b> Cost/Capex</div>
            <div class="def-item"><b>C3:</b> Persistence</div>
            <div class="def-item"><b>C4:</b> “Strategic initiatives”</div>
          </div>
        </div>

        <div id="err" class="error"></div>
      </section>

      <aside class="card">
        <h2>Recent events</h2>
        <div class="table-wrap">
          <table style="min-width: 520px">
            <thead>
              <tr>
                <th>Company</th>
                <th>Date</th>
                <th>Change</th>
              </tr>
            </thead>
            <tbody id="eventsBody">
              <tr>
                <td colspan="3" class="muted">Only state changes are logged as events.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </aside>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      function safeParseJSON(s) {
        try { return JSON.parse(s); } catch { return null; }
      }

      function asInt(v) {
        if (v === true) return 1;
        if (v === false) return 0;
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }

      function setError(msg) {
        $("err").textContent = msg || "";
      }

      function normalizePayload(raw) {
        // Expected from export_dashboard.py:
        // { companies: [...], latest_state: [...], events: [...] }
        const companies = Array.isArray(raw?.companies) ? raw.companies : [];
        const latest = Array.isArray(raw?.latest_state) ? raw.latest_state : [];
        const events = Array.isArray(raw?.events) ? raw.events : [];
        return { companies, latest, events };
      }

      function buildCompanyMap(companies) {
        const m = new Map();
        for (const c of companies) {
          if (!c || !c.company_id) continue;
          m.set(String(c.company_id), c);
        }
        return m;
      }

      function renderLatest({ companies, latest }) {
        const companyMap = buildCompanyMap(companies);

        // Enrich latest rows with company metadata (ticker/bucket/in_scope)
        const rows = latest.map((ms) => {
          const cid = String(ms.company_id ?? "");
          const c = companyMap.get(cid) || {};
          return {
            company_id: cid,
            ticker: c.ticker ?? cid,
            bucket: c.bucket ?? "—",
            in_scope: asInt(c.in_scope),
            as_of: ms.as_of ?? "",
            state: ms.state ?? "—",
            c1: asInt(ms.condition_1),
            c2: asInt(ms.condition_2),
            c3: asInt(ms.condition_3),
            c4: asInt(ms.condition_4),
            details_json: ms.details_json ?? null
          };
        });

        // Sort by ticker
        rows.sort((a, b) => String(a.ticker).localeCompare(String(b.ticker)));

        // Subhead
        $("subhead").textContent = `Loaded ${rows.length} companies.`;

        // Table
        const body = $("latestBody");
        body.innerHTML = "";
        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.className = "data-row";
          tr.dataset.cid = r.company_id;

          tr.innerHTML = `
            <td>${escapeHtml(String(r.ticker))}</td>
            <td>${escapeHtml(String(r.bucket))}</td>
            <td><span class="chip">${escapeHtml(String(r.state))}</span></td>
            <td>${escapeHtml(String(r.as_of))}</td>
            <td>${r.c1}</td>
            <td>${r.c2}</td>
            <td>${r.c3}</td>
            <td>${r.c4}</td>
            <td>${r.in_scope}</td>
          `;

          tr.addEventListener("click", () => selectCompany(rows, r.company_id));
          body.appendChild(tr);
        }

        // Dropdown
        const sel = $("tickerSelect");
        sel.innerHTML = `<option value="">Select a ticker…</option>`;
        for (const r of rows) {
          const opt = document.createElement("option");
          opt.value = r.company_id;
          opt.textContent = String(r.ticker);
          sel.appendChild(opt);
        }

        sel.onchange = () => {
          const cid = sel.value;
          if (!cid) {
            $("detailsPre").textContent = "No ticker selected.";
            return;
          }
          selectCompany(rows, cid);
        };

        // If there’s exactly one row, auto-select it (nice for initial debugging)
        if (rows.length === 1) selectCompany(rows, rows[0].company_id);
      }

      function selectCompany(rows, companyId) {
        const r = rows.find(x => String(x.company_id) === String(companyId));
        if (!r) return;

        $("tickerSelect").value = String(companyId);

        // details_json might already be a JSON string or null.
        // If it’s a string, pretty print it. If not, show something sane.
        if (!r.details_json) {
          $("detailsPre").textContent = "No details_json available for this ticker yet.";
          return;
        }

        const parsed = (typeof r.details_json === "string") ? safeParseJSON(r.details_json) : r.details_json;
        if (!parsed) {
          $("detailsPre").textContent = String(r.details_json);
          return;
        }
        $("detailsPre").textContent = JSON.stringify(parsed, null, 2);
      }

      function renderEvents({ companies, events }) {
        const companyMap = buildCompanyMap(companies);
        const tbody = $("eventsBody");
        tbody.innerHTML = "";

        if (!events.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" class="muted">No state-change events yet.</td>
            </tr>
            <tr>
              <td colspan="3" class="muted">Only state changes are logged as events.</td>
            </tr>
          `;
          return;
        }

        // Show up to 50 most recent
        const slice = events.slice(0, 50);

        for (const e of slice) {
          const cid = String(e.company_id ?? "");
          const c = companyMap.get(cid) || {};
          const ticker = c.ticker ?? cid;

          const prev = e.prev_state ?? "—";
          const next = e.new_state ?? "—";
          const asOf = e.as_of ?? "—";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(String(ticker))}</td>
            <td>${escapeHtml(String(asOf))}</td>
            <td>${escapeHtml(String(prev))} → ${escapeHtml(String(next))}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      function escapeHtml(str) {
        return str
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function loadDashboard() {
        setError("");

        // dashboard.json lives next to this index.html (in /docs on GitHub Pages)
        const url = `dashboard.json?t=${Date.now()}`;

        let raw;
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status} fetching ${url}`);
          raw = await res.json();
        } catch (e) {
          $("subhead").textContent = "Failed to load dashboard.json.";
          setError(String(e));
          return;
        }

        const data = normalizePayload(raw);

        try {
          renderLatest(data);
          renderEvents(data);
        } catch (e) {
          setError(`Render error: ${String(e)}\n\n(If you just changed the JSON schema, refresh after you re-export + commit docs/dashboard.json.)`);
        }
      }

      loadDashboard();
    </script>
  </body>
</html>
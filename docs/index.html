<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPACShortModel</title>
  <style>
    :root{
      --bg0:#070913;
      --bg1:#0b1026;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --muted2:rgba(255,255,255,.45);
      --good:#44d18d;
      --bad:#ff5a7a;
      --warn:#f7b64c;
      --pill:rgba(130,140,255,.16);
      --pillBorder:rgba(130,140,255,.35);
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 12% 10%, rgba(110,105,255,.16), transparent 60%),
        radial-gradient(700px 500px at 80% 35%, rgba(80,255,170,.10), transparent 65%),
        radial-gradient(900px 600px at 40% 90%, rgba(255,85,160,.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:28px 18px 70px}
    .top{
      display:flex;align-items:flex-start;gap:16px;margin-bottom:18px
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(180deg, rgba(140,150,255,.9), rgba(110,105,255,.55));
      box-shadow:0 10px 25px rgba(110,105,255,.22);
      display:grid;place-items:center;flex:0 0 auto
    }
    .logo svg{opacity:.9}
    h1{margin:0;font-size:52px;letter-spacing:-.02em}
    .sub{margin-top:6px;color:var(--muted);font-size:15px}
    .err{margin-top:6px;color:var(--bad);font-size:14px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
      margin-top:16px;
    }
    .card .hd{
      padding:18px 18px 10px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px
    }
    .card h2{margin:0;font-size:22px}
    .card .hint{color:var(--muted2);font-size:12px;margin-top:6px}
    .pillrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      border-radius:999px;
      padding:7px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }
    .pill.live{border-color:rgba(247,182,76,.35);background:rgba(247,182,76,.08)}
    .pill.ok{border-color:rgba(68,209,141,.35);background:rgba(68,209,141,.08)}
    .pill.bad{border-color:rgba(255,90,122,.35);background:rgba(255,90,122,.08)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;padding:0 18px 18px}
    .controls{
      padding:0 18px 14px;
      display:grid;
      grid-template-columns: 1.2fr 180px 180px 240px;
      gap:10px;
      align-items:center;
    }
    .input, select{
      width:100%;
      border-radius:12px;
      padding:12px 12px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    select{cursor:pointer}
    .tblwrap{overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th, td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{
      font-size:12px;color:var(--muted2);
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    td{font-size:14px;color:rgba(255,255,255,.86)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      font-family:var(--mono);
      font-size:12px;
      padding:6px 10px;border-radius:10px;
      border:1px solid var(--pillBorder);
      background:var(--pill);
      color:rgba(190,200,255,.92);
      white-space:nowrap;
    }
    .state{
      display:inline-flex;align-items:center;gap:8px;
      font-family:var(--mono);font-size:12px;
      padding:6px 10px;border-radius:10px;border:1px solid rgba(150,160,255,.30);
      background:rgba(110,105,255,.14);
      color:rgba(215,220,255,.95);
    }
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      font-family:var(--mono);font-size:11px;
      padding:5px 9px;border-radius:9px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      min-width:46px;
      white-space:nowrap;
    }
    .ok{border-color:rgba(68,209,141,.25);background:rgba(68,209,141,.10);color:rgba(120,255,190,.95)}
    .flag{border-color:rgba(255,90,122,.25);background:rgba(255,90,122,.12);color:rgba(255,160,178,.95)}
    .muted{color:var(--muted)}
    .right{display:flex;justify-content:flex-end}
    .pctUp{color:rgba(120,255,190,.95);font-family:var(--mono)}
    .pctDn{color:rgba(255,160,178,.95);font-family:var(--mono)}
    .foot{
      padding:12px 18px 18px;
      color:var(--muted2);
      font-size:12px;
    }
    .legend{
      padding:0 18px 18px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .legend .chip{
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:10px 12px;
      font-size:12px;
      color:rgba(255,255,255,.74);
      font-family:var(--mono);
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--warn);
      display:inline-block;margin-right:8px;vertical-align:middle
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo" aria-hidden="true">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M4 19V5" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 19V11" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19V7" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M16 19V13" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 19V9" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div style="flex:1">
        <h1>SPACShortModel</h1>
        <div class="sub" id="subline">Loading…</div>
        <div class="err" id="errline" style="display:none"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h2>Recent Events</h2>
          <div class="hint">State transitions are logged as discrete events</div>
        </div>
      </div>
      <div class="tblwrap">
        <table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Company</th>
              <th>Date</th>
              <th>Transition</th>
            </tr>
          </thead>
          <tbody id="eventsBody">
            <tr><td class="muted" colspan="4">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <h2 style="margin-right:4px">Current State</h2>
          <span class="pill live" id="liveStatus"><span class="dot"></span>Live quotes</span>
        </div>
        <div class="pillrow">
          <span class="pill" id="genStamp">Generated: --</span>
          <span class="pill" id="dbStamp">DB Updated: --</span>
        </div>
      </div>

      <div class="controls">
        <input class="input" id="search" placeholder="Ticker, company, bucket…" />

        <select id="scopeSel">
          <option value="all">All</option>
          <option value="in">In scope</option>
          <option value="out">Out of scope</option>
        </select>

        <select id="stateSel">
          <option value="all">All states</option>
          <option value="MONITOR">MONITOR</option>
          <option value="NO_DATA">NO_DATA</option>
          <option value="OUT_OF_SCOPE">OUT_OF_SCOPE</option>
        </select>

        <select id="sortSel">
          <option value="pressure_desc">Pressure (high to low)</option>
          <option value="pressure_asc">Pressure (low to high)</option>
          <option value="ticker_asc">Ticker (A to Z)</option>
          <option value="ticker_desc">Ticker (Z to A)</option>
        </select>
      </div>

      <div class="tblwrap">
        <table>
          <thead>
            <tr>
              <th>Company</th>
              <th>Ticker</th>
              <th>Bucket</th>
              <th>State</th>
              <th>Pressure</th>
              <th>C1</th>
              <th>C2</th>
              <th>C3</th>
              <th>C4</th>
              <th>Live Price</th>
              <th>Live %</th>
              <th>Scope</th>
            </tr>
          </thead>
          <tbody id="rowsBody">
            <tr><td class="muted" colspan="12">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="legend">
        <div class="chip"><b>C1</b> Demand or margin pressure (revenue decel OR profitability deterioration)</div>
        <div class="chip"><b>C2</b> Capex spike vs baseline</div>
        <div class="chip"><b>C3</b> Burn persists + discretionary spend continues + no slope improvement</div>
        <div class="chip"><b>C4</b> Strategic initiative language + no slope improvement</div>
      </div>

      <div class="foot">
        Live quotes are fetched in your browser from Yahoo Finance (via a CORS proxy) and refresh automatically.
        Fundamentals and conditions are generated nightly.
      </div>
    </div>
  </div>

  <script>
    const DASHBOARD_URL = "./dashboard.json";

    // Yahoo quote endpoint (unofficial) + CORS proxy wrapper
    const YAHOO_QUOTE = (symbolsCsv) =>
      "https://api.allorigins.win/raw?url=" +
      encodeURIComponent("https://query1.finance.yahoo.com/v7/finance/quote?symbols=" + symbolsCsv);

    const LIVE_REFRESH_MS = 30000;

    let DASH = null;
    let COMP_BY_ID = new Map();
    let LIVE = new Map(); // ticker -> { price, changePercent, time }

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setErr(msg){
      const el = document.getElementById("errline");
      if(!msg){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block";
      el.textContent = msg;
    }

    function fmtPct(x){
      if(x === null || x === undefined || Number.isNaN(x)) return "--";
      const v = Number(x);
      const s = (v >= 0 ? "+" : "") + v.toFixed(2) + "%";
      return s;
    }

    function pressureLabel(c1,c2,c3,c4){
      const score = (c1?1:0)+(c2?1:0)+(c3?1:0)+(c4?1:0);
      if(score >= 2) return {txt: score + " ELEVATED", cls:"flag"};
      if(score === 1) return {txt: score + " WATCH", cls:""};
      return {txt: score + " STABLE", cls:"ok"};
    }

    function asBool(v){
      return v === 1 || v === true || v === "1";
    }

    function sortRows(rows, mode){
      const cp = rows.slice();
      if(mode === "ticker_asc") cp.sort((a,b)=>a.ticker.localeCompare(b.ticker));
      else if(mode === "ticker_desc") cp.sort((a,b)=>b.ticker.localeCompare(a.ticker));
      else if(mode === "pressure_asc") cp.sort((a,b)=>a.pressureScore - b.pressureScore);
      else cp.sort((a,b)=>b.pressureScore - a.pressureScore);
      return cp;
    }

    function buildRow(r){
      const c = COMP_BY_ID.get(r.company_id) || {};
      const name = c.name || c.company_id || "";
      const bucket = c.bucket || "";
      const inScope = !!c.in_scope;

      const c1 = asBool(r.condition_1);
      const c2 = asBool(r.condition_2);
      const c3 = asBool(r.condition_3);
      const c4 = asBool(r.condition_4);

      const pressureScore = (c1?1:0)+(c2?1:0)+(c3?1:0)+(c4?1:0);
      const p = pressureLabel(c1,c2,c3,c4);

      const live = LIVE.get(r.company_id) || LIVE.get(c.ticker) || null;
      const livePrice = live ? live.price : null;
      const livePct = live ? live.changePercent : null;

      const pctCls = (livePct === null || livePct === undefined) ? "muted" : (livePct >= 0 ? "pctUp" : "pctDn");

      return {
        company: name,
        ticker: c.ticker || r.company_id || "",
        bucket,
        state: r.state || "",
        pressureScore,
        pressureText: p.txt,
        pressureCls: p.cls,
        c1, c2, c3, c4,
        livePrice,
        livePct,
        scopeText: inScope ? "IN" : "OUT"
      };
    }

    function render(){
      if(!DASH){
        return;
      }

      // Header
      const companies = (DASH.companies || []);
      const inScopeCount = companies.filter(x=>x.in_scope).length;
      document.getElementById("subline").textContent =
        `Tracking ${companies.length} companies (in scope: ${inScopeCount})`;

      document.getElementById("genStamp").textContent = "Generated: " + (DASH.generated_at || "--");
      // If you later add a DB timestamp into JSON, set it here. For now we show "--".
      document.getElementById("dbStamp").textContent = "DB Updated: " + (DASH.db_updated_at || "--");

      // Events
      const ev = (DASH.events || []).slice(0, 12);
      const evBody = document.getElementById("eventsBody");
      if(ev.length === 0){
        evBody.innerHTML = `<tr><td class="muted" colspan="4">No state transitions recorded</td></tr>`;
      } else {
        evBody.innerHTML = ev.map(e=>{
          const c = COMP_BY_ID.get(e.company_id) || {};
          const nm = c.name || e.company_id || "";
          const dt = e.as_of || "";
          const tr = `${e.prev_state || ""} → ${e.new_state || ""}`;
          return `<tr>
            <td><span class="tag">${esc(c.ticker || e.company_id || "")}</span></td>
            <td class="muted">${esc(nm)}</td>
            <td class="muted" style="font-family:var(--mono)">${esc(dt)}</td>
            <td style="font-family:var(--mono)">${esc(tr)}</td>
          </tr>`;
        }).join("");
      }

      // Rows
      const raw = (DASH.latest_state || []);
      let rows = raw.map(buildRow);

      // Filters
      const q = document.getElementById("search").value.trim().toLowerCase();
      const scope = document.getElementById("scopeSel").value;
      const state = document.getElementById("stateSel").value;
      const sort = document.getElementById("sortSel").value;

      if(q){
        rows = rows.filter(r =>
          (r.ticker||"").toLowerCase().includes(q) ||
          (r.company||"").toLowerCase().includes(q) ||
          (r.bucket||"").toLowerCase().includes(q)
        );
      }

      if(scope !== "all"){
        rows = rows.filter(r => (scope === "in" ? r.scopeText === "IN" : r.scopeText === "OUT"));
      }

      if(state !== "all"){
        rows = rows.filter(r => r.state === state);
      }

      rows = sortRows(rows, sort);

      const body = document.getElementById("rowsBody");
      if(rows.length === 0){
        body.innerHTML = `<tr><td class="muted" colspan="12">No matches</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(r=>{
        const c1 = r.c1 ? "flag" : "ok";
        const c2 = r.c2 ? "flag" : "ok";
        const c3 = r.c3 ? "flag" : "ok";
        const c4 = r.c4 ? "flag" : "ok";

        const lp = (r.livePrice === null || r.livePrice === undefined) ? "--" : Number(r.livePrice).toFixed(2);

        return `<tr>
          <td class="muted">${esc(r.company)}</td>
          <td><span class="tag">${esc(r.ticker)}</span></td>
          <td class="muted">${esc(r.bucket)}</td>
          <td><span class="state">${esc(r.state)}</span></td>
          <td><span class="badge ${esc(r.pressureCls)}">${esc(r.pressureText)}</span></td>
          <td><span class="badge ${c1}">${r.c1 ? "FLAG" : "OK"}</span></td>
          <td><span class="badge ${c2}">${r.c2 ? "FLAG" : "OK"}</span></td>
          <td><span class="badge ${c3}">${r.c3 ? "FLAG" : "OK"}</span></td>
          <td><span class="badge ${c4}">${r.c4 ? "FLAG" : "OK"}</span></td>
          <td style="font-family:var(--mono)">${esc(lp)}</td>
          <td class="${r.livePct === null || r.livePct === undefined ? "muted" : (r.livePct >= 0 ? "pctUp" : "pctDn")}" style="font-family:var(--mono)">
            ${esc(fmtPct(r.livePct))}
          </td>
          <td class="${r.scopeText==="IN" ? "pctUp" : "muted"}" style="font-family:var(--mono)">${esc(r.scopeText)}</td>
        </tr>`;
      }).join("");
    }

    async function loadDashboard(){
      setErr("");
      try{
        const res = await fetch(DASHBOARD_URL, { cache: "no-store" });
        if(!res.ok) throw new Error("dashboard.json HTTP " + res.status);
        DASH = await res.json();

        // Build company map
        COMP_BY_ID = new Map();
        for(const c of (DASH.companies || [])){
          COMP_BY_ID.set(c.company_id, c);
          if(c.ticker) COMP_BY_ID.set(c.ticker, c);
        }

        render();
      } catch(e){
        setErr("Connection failed (dashboard.json). " + e.message);
        document.getElementById("eventsBody").innerHTML =
          `<tr><td class="muted" colspan="4">Failed to fetch</td></tr>`;
        document.getElementById("rowsBody").innerHTML =
          `<tr><td class="muted" colspan="12">Failed to fetch</td></tr>`;
      }
    }

    function setLiveStatus(mode, msg){
      const el = document.getElementById("liveStatus");
      el.classList.remove("ok","bad");
      if(mode === "ok"){ el.classList.add("ok"); }
      if(mode === "bad"){ el.classList.add("bad"); }
      el.innerHTML = `<span class="dot"></span>${esc(msg)}`;
    }

    async function refreshLiveQuotes(){
      if(!DASH) return;

      // Only pull live quotes for MONITOR rows (change if you want)
      const stateRows = (DASH.latest_state || []);
      const symbols = [];

      for(const r of stateRows){
        if((r.state || "") !== "MONITOR") continue;
        const c = COMP_BY_ID.get(r.company_id) || {};
        if(c.ticker) symbols.push(c.ticker);
      }

      if(symbols.length === 0){
        setLiveStatus("bad","Live quotes (no MONITOR tickers)");
        return;
      }

      const csv = symbols.join(",");
      const url = YAHOO_QUOTE(csv);

      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("quote HTTP " + res.status);
        const data = await res.json();

        const results = (((data||{}).quoteResponse||{}).result || []);
        const now = new Date().toISOString();

        for(const q of results){
          const sym = q.symbol;
          if(!sym) continue;

          const price = (q.regularMarketPrice ?? null);
          const pct = (q.regularMarketChangePercent ?? null);

          LIVE.set(sym, {
            price: price === null ? null : Number(price),
            changePercent: pct === null ? null : Number(pct),
            time: now
          });
        }

        setLiveStatus("ok","Live quotes (Yahoo)");
        render();
      } catch(e){
        // Key point: do NOT kill the dashboard if live quotes fail.
        setLiveStatus("bad","Live quotes unavailable");
        // keep rendering static dashboard
        render();
      }
    }

    function wire(){
      ["search","scopeSel","stateSel","sortSel"].forEach(id=>{
        document.getElementById(id).addEventListener("input", render);
        document.getElementById(id).addEventListener("change", render);
      });
    }

    (async function boot(){
      wire();
      await loadDashboard();
      await refreshLiveQuotes();
      setInterval(refreshLiveQuotes, LIVE_REFRESH_MS);
    })();
  </script>
</body>
</html>
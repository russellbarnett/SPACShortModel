<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPACShortModel</title>
    <style>
      :root{
        --bg:#f6f8fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --line:#e2e8f0;
        --shadow: 0 12px 30px rgba(2,6,23,.06);
        --radius:16px;

        --ok-bg:#ecfdf3;
        --ok-bd:#b7e3c0;
        --ok-tx:#166534;

        --bad-bg:#fff1f2;
        --bad-bd:#fecdd3;
        --bad-tx:#9f1239;

        --warn-bg:#fff7ed;
        --warn-bd:#fed7aa;
        --warn-tx:#9a3412;

        --pill-bg:#f1f5f9;
        --pill-bd:#dbe4f0;
        --pill-tx:#0f172a;

        --g-stable-bg:#ecfdf3; --g-stable-bd:#b7e3c0; --g-stable-tx:#166534;
        --g-watch-bg:#fff7ed;  --g-watch-bd:#fed7aa;  --g-watch-tx:#9a3412;
        --g-elev-bg:#fff1f2;   --g-elev-bd:#fecdd3;   --g-elev-tx:#9f1239;
        --g-crit-bg:#fee2e2;   --g-crit-bd:#fca5a5;   --g-crit-tx:#7f1d1d;

        --dot-stable:#16a34a;
        --dot-watch:#f59e0b;
        --dot-elev:#f97316;
        --dot-crit:#ef4444;
        --dot-oos:#94a3b8;
      }

      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }

      .wrap{
        max-width: 1120px;
        margin: 0 auto;
        padding: 28px 18px 40px;
      }

      header{ margin-bottom: 18px; }

      h1{
        font-size: 56px;
        line-height: 1.02;
        letter-spacing: -0.02em;
        margin: 0 0 6px;
      }

      .sub{
        color: var(--muted);
        font-size: 18px;
        margin: 0;
      }

      .grid{
        display:grid;
        grid-template-columns: 1.45fr 1fr;
        gap: 16px;
        align-items: start;
      }

      @media (max-width: 980px){
        .grid{grid-template-columns: 1fr;}
        h1{font-size: 44px;}
      }

      .card{
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow:hidden;
      }

      .card-head{
        padding: 18px 18px 10px;
        border-bottom: 1px solid var(--line);
      }

      .card-title{
        font-size: 36px;
        letter-spacing: -0.02em;
        margin: 0 0 10px;
      }

      .controls{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .control{
        display:flex;
        align-items:center;
        gap:10px;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 14px;
        background: #fff;
        min-height: 42px;
      }

      .control input, .control select{
        border:none;
        outline:none;
        font-size: 15px;
        min-width: 180px;
        background: transparent;
      }

      .control select{ min-width: 160px; }

      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12px;
        letter-spacing: .02em;
        border: 1px solid var(--pill-bd);
        background: var(--pill-bg);
        color: var(--pill-tx);
        white-space: nowrap;
      }

      .chip.stable{ background: var(--g-stable-bg); border-color: var(--g-stable-bd); color: var(--g-stable-tx); }
      .chip.watch{  background: var(--g-watch-bg);  border-color: var(--g-watch-bd);  color: var(--g-watch-tx); }
      .chip.elev{   background: var(--g-elev-bg);   border-color: var(--g-elev-bd);   color: var(--g-elev-tx); }
      .chip.crit{   background: var(--g-crit-bg);   border-color: var(--g-crit-bd);   color: var(--g-crit-tx); }
      .chip.oos{    background: #f1f5f9; border-color:#e2e8f0; color:#475569; }

      .dot{
        width: 9px;
        height: 9px;
        border-radius: 999px;
        display:inline-block;
      }

      .muted{ color: var(--muted); }
      .small{ font-size: 12px; color: var(--muted); }

      .table-wrap{ overflow: hidden; }

      table{
        width: 100%;
        border-collapse: collapse;
      }

      th, td{
        padding: 12px 12px;
        border-bottom: 1px solid var(--line);
        vertical-align: middle;
        text-align: left;
      }

      th{
        font-size: 13px;
        color: #334155;
        background: #fbfdff;
        position: sticky;
        top: 0;
        z-index: 2;
        white-space: nowrap;
      }

      tbody tr:hover{ background: #fbfdff; }

      .ticker{
        font-weight: 900;
        letter-spacing: .02em;
        white-space: nowrap;
      }

      .bucket{
        color:#0f172a;
        white-space: nowrap;
      }

      .trigs{
        display:flex;
        gap:6px;
        flex-wrap: wrap;
      }

      .badge{
        display:inline-flex;
        align-items:center;
        padding: 3px 8px;
        border-radius: 999px;
        font-weight: 900;
        font-size: 12px;
        border: 1px solid #fecdd3;
        background: #fff1f2;
        color: #9f1239;
        white-space: nowrap;
      }

      .badge.ok{
        border-color:#dbe4f0;
        background:#f1f5f9;
        color:#334155;
        font-weight: 800;
      }

      .spark{
        width: 110px;
        height: 24px;
        display:block;
      }
      .spark path{
        fill: none;
        stroke: #2563eb;
        stroke-width: 2;
        opacity: .85;
      }
      .spark .baseline{
        stroke: #cbd5e1;
        stroke-width: 1;
        opacity: .8;
      }

      .priceCell{
        display:flex;
        gap:10px;
        align-items:center;
        justify-content:flex-start;
      }

      .pct{
        font-weight: 900;
        font-size: 13px;
        white-space: nowrap;
      }

      .pct.up{ color: #166534; }
      .pct.down{ color: #9f1239; }
      .pct.flat{ color: var(--muted); }

      .scope{
        font-weight: 900;
        white-space: nowrap;
      }

      .scope.in{ color:#166534; }
      .scope.out{ color:#475569; }

      .footer{
        margin-top: 16px;
        padding: 14px 18px;
        border-top: 1px solid var(--line);
        background: #fbfdff;
      }

      .defs{
        display:flex;
        gap:12px;
        flex-wrap: wrap;
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .defs li{
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 14px;
        color: #0f172a;
      }

      .defs b{ display:inline-block; min-width: 26px; }

      .events table{ width: 100%; }
      .events td, .events th{ white-space: nowrap; }
      .note{ padding: 14px 18px; color: var(--muted); font-size: 14px; }

      /* Responsive tightening */
      @media (max-width: 760px){
        th:nth-child(2), td:nth-child(2){ display:none; } /* Bucket */
        th:nth-child(4), td:nth-child(4){ display:none; } /* As of */
        .spark{ width: 90px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <h1>SPACShortModel</h1>
        <p class="sub" id="subtitle">Loading…</p>
      </header>

      <div class="grid">
        <section class="card">
          <div class="card-head">
            <div style="display:flex; gap:12px; align-items:baseline; flex-wrap:wrap;">
              <h2 class="card-title" style="margin:0;">Latest state</h2>
            </div>

            <div class="controls" style="margin-top:12px;">
              <div class="control">
                <span class="small">Search</span>
                <input id="q" placeholder="ticker or bucket…" />
              </div>

              <div class="control">
                <span class="small">Scope</span>
                <select id="scope">
                  <option value="all">All</option>
                  <option value="in">In scope only</option>
                  <option value="out">Out of scope only</option>
                </select>
              </div>

              <div class="control">
                <span class="small">Grade</span>
                <select id="gradeFilter">
                  <option value="all">All</option>
                  <option value="CRITICAL">Critical</option>
                  <option value="ELEVATED">Elevated</option>
                  <option value="WATCH">Watch</option>
                  <option value="STABLE">Stable</option>
                  <option value="OUT_OF_SCOPE">Out of scope</option>
                </select>
              </div>

              <div class="control" style="min-width: 260px;">
                <span class="small" id="updated">Updated: —</span>
              </div>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Bucket</th>
                  <th>State</th>
                  <th>As of</th>
                  <th>Pressure</th>
                  <th>Triggers</th>
                  <th>Price (1m)</th>
                  <th>In scope</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="footer">
            <ul class="defs">
              <li><b>C1:</b> Demand/Margin</li>
              <li><b>C2:</b> Cost/Capex</li>
              <li><b>C3:</b> Persistence</li>
              <li><b>C4:</b> “Strategic initiatives”</li>
            </ul>
            <div class="small" style="margin-top:10px;">
              Pressure score is 0–10 (conditions weighted + 1m price stress). Triggers show only the conditions currently firing.
            </div>
          </div>
        </section>

        <aside class="card events">
          <div class="card-head">
            <h2 class="card-title" style="margin:0;">Recent events</h2>
            <div class="small" style="margin-top:6px;">Only state changes are logged as events.</div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Date</th>
                  <th>Change</th>
                </tr>
              </thead>
              <tbody id="events"></tbody>
            </table>
          </div>

          <div class="note" id="eventsNote"></div>
        </aside>
      </div>
    </div>

    <script>
      function pctClass(p){
        const n = Number(p);
        if(!Number.isFinite(n)) return "flat";
        if(n > 0.25) return "up";
        if(n < -0.25) return "down";
        return "flat";
      }

      function fmtPct(p){
        const n = Number(p);
        if(!Number.isFinite(n)) return "n/a";
        const sign = n > 0 ? "+" : "";
        return `${sign}${n.toFixed(1)}%`;
      }

      function svgSparkline(values){
        if(!Array.isArray(values) || values.length < 2) return "";
        const w = 110, h = 24, pad = 2;

        const clean = values.map(v => Number(v)).filter(v => Number.isFinite(v));
        if(clean.length < 2) return "";

        let min = Math.min(...clean);
        let max = Math.max(...clean);
        if(min === max){ min -= 1; max += 1; }

        const xStep = (w - pad*2) / (clean.length - 1);
        const y = (v) => {
          const t = (v - min) / (max - min);
          return (h - pad) - t * (h - pad*2);
        };

        let d = "";
        for(let i=0;i<clean.length;i++){
          const x = pad + i * xStep;
          const yy = y(clean[i]);
          d += (i===0 ? "M" : " L") + x.toFixed(2) + " " + yy.toFixed(2);
        }

        const baseY = y(clean[0]).toFixed(2);

        return `
          <svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
            <path class="baseline" d="M${pad} ${baseY} L${w-pad} ${baseY}"></path>
            <path d="${d}"></path>
          </svg>
        `;
      }

      function priceCell(row){
        const p = row.price_1m;
        if(!p || !Array.isArray(p.closes) || p.closes.length < 2){
          return `<div class="priceCell"><span class="small">n/a</span></div>`;
        }
        const spark = svgSparkline(p.closes);
        const pct = fmtPct(p.pct_change);
        const cls = pctClass(p.pct_change);
        return `
          <div class="priceCell">
            ${spark}
            <span class="pct ${cls}">${pct}</span>
          </div>
        `;
      }

      function gradeDot(grade){
        if(grade === "CRITICAL") return `style="background:var(--dot-crit)"`;
        if(grade === "ELEVATED") return `style="background:var(--dot-elev)"`;
        if(grade === "WATCH") return `style="background:var(--dot-watch)"`;
        if(grade === "STABLE") return `style="background:var(--dot-stable)"`;
        return `style="background:var(--dot-oos)"`;
      }

      function gradeChip(grade, score){
        if(grade === "CRITICAL") return `<span class="chip crit"><span class="dot" ${gradeDot(grade)}></span>${grade} · ${score}</span>`;
        if(grade === "ELEVATED") return `<span class="chip elev"><span class="dot" ${gradeDot(grade)}></span>${grade} · ${score}</span>`;
        if(grade === "WATCH") return `<span class="chip watch"><span class="dot" ${gradeDot(grade)}></span>${grade} · ${score}</span>`;
        if(grade === "STABLE") return `<span class="chip stable"><span class="dot" ${gradeDot(grade)}></span>${grade} · ${score}</span>`;
        return `<span class="chip oos"><span class="dot" ${gradeDot(grade)}></span>${grade}</span>`;
      }

      function triggersCell(trigs){
        if(!Array.isArray(trigs) || trigs.length === 0){
          return `<div class="trigs"><span class="badge ok">None</span></div>`;
        }
        return `<div class="trigs">${trigs.map(t => `<span class="badge">${t}</span>`).join("")}</div>`;
      }

      function scopeCell(v){
        const n = Number(v);
        if(n === 1) return `<span class="scope in">✅</span>`;
        return `<span class="scope out">⛔</span>`;
      }

      function normalize(data){
        const latest = (data.latest_state || []).map(r => ({
          ticker: r.ticker || r.company_id,
          bucket: r.bucket || "—",
          state: r.state || "—",
          as_of: r.as_of || "",
          in_scope: Number(r.in_scope) === 1 ? 1 : 0,

          pressure_score: (typeof r.pressure_score === "number") ? r.pressure_score : null,
          pressure_grade: r.pressure_grade || (Number(r.in_scope) === 1 ? "STABLE" : "OUT_OF_SCOPE"),
          triggered_conditions: r.triggered_conditions || [],

          price_1m: r.price_1m || null
        }));

        // Sort: highest pressure first, then biggest drop
        latest.sort((a,b) => {
          const as = (a.pressure_score === null ? -1 : a.pressure_score);
          const bs = (b.pressure_score === null ? -1 : b.pressure_score);
          if(bs !== as) return bs - as;

          const ar = a.price_1m?.pct_change;
          const br = b.price_1m?.pct_change;
          const arn = (typeof ar === "number") ? ar : 999;
          const brn = (typeof br === "number") ? br : 999;
          return arn - brn;
        });

        const events = (data.events || []).map(e => ({
          company_id: e.company_id,
          as_of: e.as_of,
          prev_state: e.prev_state,
          new_state: e.new_state
        }));

        return { latest, events };
      }

      function applyFilters(rows){
        const q = (document.getElementById("q").value || "").trim().toLowerCase();
        const scope = document.getElementById("scope").value;
        const grade = document.getElementById("gradeFilter").value;

        return rows.filter(r => {
          if(scope === "in" && r.in_scope !== 1) return false;
          if(scope === "out" && r.in_scope !== 0) return false;
          if(grade !== "all" && String(r.pressure_grade) !== grade) return false;

          if(!q) return true;
          const hay = `${r.ticker} ${r.bucket} ${r.state} ${r.pressure_grade}`.toLowerCase();
          return hay.includes(q);
        });
      }

      function renderLatest(rows){
        const tbody = document.getElementById("rows");
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td class="ticker">${r.ticker}</td>
            <td class="bucket">${r.bucket}</td>
            <td><span class="chip">${r.state}</span></td>
            <td class="muted">${r.as_of}</td>
            <td>${gradeChip(r.pressure_grade, (r.pressure_score ?? "—"))}</td>
            <td>${triggersCell(r.triggered_conditions)}</td>
            <td>${priceCell(r)}</td>
            <td>${scopeCell(r.in_scope)}</td>
          </tr>
        `).join("");
      }

      function renderEvents(events, companies){
        const tbody = document.getElementById("events");
        const byId = new Map((companies || []).map(c => [String(c.company_id), c]));
        if(!events.length){
          tbody.innerHTML = `<tr><td colspan="3" class="muted">No state-change events yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = events.slice(0, 30).map(e => {
          const t = byId.get(String(e.company_id))?.ticker || e.company_id;
          return `
            <tr>
              <td class="ticker">${t}</td>
              <td class="muted">${e.as_of || ""}</td>
              <td><span class="chip">${e.prev_state} → ${e.new_state}</span></td>
            </tr>
          `;
        }).join("");
      }

      async function load(){
        const res = await fetch("./dashboard.json", { cache: "no-store" });
        if(!res.ok) throw new Error(`Failed to load dashboard.json (${res.status})`);
        const data = await res.json();

        const { latest, events } = normalize(data);

        document.getElementById("subtitle").textContent = `Loaded ${latest.length} companies.`;
        document.getElementById("updated").textContent = `Updated: ${data.generated_at || "—"}`;

        function rerender(){
          const filtered = applyFilters(latest);
          renderLatest(filtered);
          renderEvents(events, data.companies || []);
        }

        document.getElementById("q").addEventListener("input", rerender);
        document.getElementById("scope").addEventListener("change", rerender);
        document.getElementById("gradeFilter").addEventListener("change", rerender);

        rerender();
      }

      load().catch(err => {
        document.getElementById("subtitle").textContent = "Dashboard failed to load.";
        document.getElementById("rows").innerHTML =
          `<tr><td colspan="8" style="color:#b91c1c; font-weight:900;">${err.message}</td></tr>`;
      });
    </script>
  </body>
</html>
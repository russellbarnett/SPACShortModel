<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPACShortModel</title>
  <style>
    :root{
      --bg0:#070a12;
      --bg1:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.55);
      --text:rgba(255,255,255,.92);
      --good:#2ecc71;
      --bad:#ff4d4d;
      --warn:#f6c177;
      --chip:rgba(120,120,255,.18);
      --chipStroke:rgba(120,120,255,.40);
      --accent:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(139,92,246,.20), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(59,130,246,.14), transparent 60%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0px, rgba(255,255,255,.03) 1px, transparent 1px, transparent 120px),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding:32px 18px 60px;
    }
    .wrap{max-width:1120px;margin:0 auto}
    .top{
      display:flex;align-items:flex-start;gap:14px;margin-bottom:18px
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(59,130,246,.65));
      display:grid;place-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logo svg{opacity:.95}
    h1{margin:0;font-size:48px;letter-spacing:-.02em;line-height:1.05}
    .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .err{color:var(--bad);font-size:14px;margin-top:6px}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:0 30px 70px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-top:14px;
    }
    .card h2{
      margin:0 0 8px;
      font-size:18px;
      letter-spacing:-.01em;
    }
    .card .hint{margin:0 0 12px;color:var(--muted);font-size:12px}

    .row{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      margin:8px 0 10px;
    }
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);display:inline-block}
    .meta{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
      color:var(--muted);font-size:12px;
    }
    input[type="search"], select{
      height:38px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      min-width:210px;
    }
    select{min-width:170px}
    .tableWrap{
      overflow:auto;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.16);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
      min-width:980px;
    }
    thead th{
      text-align:left;
      padding:12px 12px;
      color:rgba(255,255,255,.45);
      background:rgba(255,255,255,.03);
      border-bottom:1px solid var(--stroke);
      position:sticky;top:0;z-index:2;
      letter-spacing:.08em;
      font-size:11px;
      text-transform:uppercase;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:hover td{background:rgba(255,255,255,.02)}
    .chip{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 9px;border-radius:10px;
      border:1px solid var(--chipStroke);
      background:var(--chip);
      font-weight:600;
      letter-spacing:.02em;
    }
    .state{background:rgba(99,102,241,.18);border-color:rgba(99,102,241,.45)}
    .scopeIn{color:var(--good);font-weight:700}
    .scopeOut{color:rgba(255,255,255,.35);font-weight:700}
    .badgeOk{
      background:rgba(46,204,113,.14);
      border:1px solid rgba(46,204,113,.33);
      color:rgba(200,255,225,.92);
      padding:4px 9px;border-radius:9px;font-weight:700;font-size:11px;
    }
    .badgeFlag{
      background:rgba(255,77,77,.14);
      border:1px solid rgba(255,77,77,.35);
      color:rgba(255,190,190,.95);
      padding:4px 9px;border-radius:9px;font-weight:800;font-size:11px;
    }
    .pressureStable{
      background:rgba(46,204,113,.12);
      border:1px solid rgba(46,204,113,.28);
      color:rgba(200,255,225,.88);
      padding:4px 9px;border-radius:9px;font-weight:800;font-size:11px;
    }
    .pressureWatch{
      background:rgba(246,193,119,.14);
      border:1px solid rgba(246,193,119,.34);
      color:rgba(255,230,200,.94);
      padding:4px 9px;border-radius:9px;font-weight:900;font-size:11px;
    }
    .pressureElev{
      background:rgba(255,77,77,.14);
      border:1px solid rgba(255,77,77,.35);
      color:rgba(255,190,190,.95);
      padding:4px 9px;border-radius:9px;font-weight:900;font-size:11px;
    }
    .spark{
      width:86px;height:20px;
      display:block;
    }

    /* NEW: sparkline + 30D % label */
    .sparkWrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sparkPct{
      font-weight:900;
      font-size:11px;
      min-width:44px;
      text-align:right;
      color:rgba(255,255,255,.75);
    }

    .legend{
      display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;color:var(--muted);font-size:12px
    }
    .legend .chip{border-radius:12px}
    .foot{
      margin-top:10px;
      color:rgba(255,255,255,.42);
      font-size:11px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="logo" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M4 19V5" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 19V10" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M11 19V7" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M15 19V12" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M19 19V9" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>SPACShortModel</h1>
        <div class="sub" id="subtitle">Loading…</div>
        <div class="err" id="globalError" style="display:none"></div>
      </div>
    </div>

    <div class="card">
      <h2>Recent Events</h2>
      <p class="hint">State transitions are logged as discrete events</p>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Company</th>
              <th>Date</th>
              <th>Transition</th>
            </tr>
          </thead>
          <tbody id="eventsBody">
            <tr><td colspan="4" style="color:rgba(255,255,255,.45);padding:14px 12px">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <h2 style="margin:0">Current State</h2>
          <span class="pill" title="Live quotes fetched in your browser">
            <span class="dot"></span> Live quotes
          </span>
        </div>
        <div class="meta">
          <span class="pill" id="genStamp">Generated: --</span>
          <span class="pill" id="dbStamp">DB Updated: --</span>
        </div>
      </div>

      <div class="row">
        <div class="filters">
          <input id="q" type="search" placeholder="Ticker, company, bucket…" />
          <select id="scopeSel">
            <option value="all">All</option>
            <option value="in">In scope</option>
            <option value="out">Out of scope</option>
          </select>
          <select id="stateSel">
            <option value="all">All states</option>
          </select>
          <select id="sortSel">
            <option value="pressure_desc">Pressure (high to low)</option>
            <option value="pressure_asc">Pressure (low to high)</option>
            <option value="ticker">Ticker (A–Z)</option>
            <option value="company">Company (A–Z)</option>
          </select>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Company</th>
              <th>Ticker</th>
              <th>Bucket</th>
              <th>State</th>
              <th>Pressure</th>
              <th>C1</th>
              <th>C2</th>
              <th>C3</th>
              <th>C4</th>
              <th>30D</th>
              <th>Live Price</th>
              <th>Live %</th>
              <th>Scope</th>
            </tr>
          </thead>
          <tbody id="stateBody">
            <tr><td colspan="13" style="color:rgba(255,255,255,.45);padding:14px 12px">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="legend" aria-label="Condition legend">
        <span class="chip">C1&nbsp;&nbsp;Demand or margin pressure (revenue decel OR profitability deterioration)</span>
        <span class="chip">C2&nbsp;&nbsp;Capex spike vs baseline</span>
        <span class="chip">C3&nbsp;&nbsp;Burn persists + discretionary spend continues + no slope improvement</span>
        <span class="chip">C4&nbsp;&nbsp;Strategic initiative language + no slope improvement</span>
      </div>

      <div class="foot">
        Live quotes and 30D charts are fetched in your browser from Yahoo Finance (via a CORS proxy) and refresh automatically. Fundamentals and conditions are generated nightly.
      </div>
    </div>
  </div>

<script>
/**
 * If your live-quote version already uses a CORS proxy, match it here.
 * corsproxy.io works for many people, but it can be flaky.
 * If you already have a known-good proxy in your current file, use that instead.
 */
const CORS_PROXY = "https://corsproxy.io/?";

/**
 * Yahoo endpoints we use:
 * - Quote:  v7/finance/quote?symbols=...
 * - Chart:  v8/finance/chart/TICKER?range=1mo&interval=1d
 */
function proxied(url){
  return CORS_PROXY + encodeURIComponent(url);
}

function fmtPct(x){
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  const v = Number(x);
  const s = (v >= 0 ? "+" : "") + v.toFixed(1) + "%";
  return s;
}
function fmtPrice(x){
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return Number(x).toFixed(2);
}
function safeText(x){
  return (x === null || x === undefined) ? "" : String(x);
}

function pressureBadge(n){
  if (n >= 2) return `<span class="pressureElev">${n} elevated</span>`;
  if (n === 1) return `<span class="pressureWatch">${n} watch</span>`;
  return `<span class="pressureStable">0 stable</span>`;
}

function cBadge(flag){
  return flag ? `<span class="badgeFlag">FLAG</span>` : `<span class="badgeOk">OK</span>`;
}

/**
 * Sparkline renderer (canvas)
 */
function renderSpark(canvas, data){
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  if (!data || data.length < 2) {
    // draw a faint baseline so the column doesn't look broken
    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(0, Math.floor(h/2));
    ctx.lineTo(w, Math.floor(h/2));
    ctx.stroke();
    ctx.globalAlpha = 1;
    return;
  }

  const min = Math.min(...data);
  const max = Math.max(...data);
  const span = (max - min) || 1;

  const pad = 1;
  const xStep = (w - pad*2) / (data.length - 1);

  // Determine direction (green if up, red if down)
  const up = data[data.length - 1] >= data[0];
  ctx.strokeStyle = up ? "#2ecc71" : "#ff4d4d";
  ctx.lineWidth = 1.6;

  ctx.beginPath();
  data.forEach((v, i) => {
    const x = pad + i * xStep;
    const y = pad + (h - pad*2) * (1 - ((v - min) / span));
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/**
 * Compute 30D % change based on first and last points
 */
function pctFromSeries(series){
  if (!series || series.length < 2) return null;
  const first = Number(series[0]);
  const last = Number(series[series.length - 1]);
  if (!Number.isFinite(first) || !Number.isFinite(last) || first === 0) return null;
  return ((last / first) - 1) * 100;
}

/**
 * Fetch 30D close series for one ticker (1mo, 1d)
 */
const chartCache = new Map(); // ticker -> { t:ms, data:number[] }
async function fetchChart30D(ticker){
  const now = Date.now();
  const cached = chartCache.get(ticker);
  if (cached && (now - cached.t) < 5 * 60 * 1000) return cached.data; // 5 min cache

  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=1mo&interval=1d`;
  const r = await fetch(proxied(url));
  if (!r.ok) throw new Error(`chart ${ticker} ${r.status}`);
  const j = await r.json();

  const result = j && j.chart && j.chart.result && j.chart.result[0];
  const closes = result && result.indicators && result.indicators.quote && result.indicators.quote[0] && result.indicators.quote[0].close;

  const cleaned = Array.isArray(closes) ? closes.filter(x => typeof x === "number" && Number.isFinite(x)) : [];
  chartCache.set(ticker, { t: now, data: cleaned });
  return cleaned;
}

/**
 * Fetch live quotes for many symbols at once (Yahoo quote endpoint)
 */
async function fetchQuotes(symbols){
  if (!symbols.length) return {};
  const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols.join(","))}`;
  const r = await fetch(proxied(url));
  if (!r.ok) throw new Error(`quote ${r.status}`);
  const j = await r.json();
  const out = {};
  const rows = (j && j.quoteResponse && j.quoteResponse.result) || [];
  for (const row of rows){
    const sym = row.symbol;
    out[sym] = {
      price: row.regularMarketPrice,
      pct: row.regularMarketChangePercent
    };
  }
  return out;
}

let DASH = null;
let COMP_BY_ID = {};
let COMPANY_ROWS = []; // enriched latest_state rows

function buildCompanyMap(dash){
  const map = {};
  for (const c of (dash.companies || [])){
    map[c.company_id] = c;
  }
  return map;
}

/**
 * Some older dashboards may have duplicates in latest_state.
 * We de-dupe by company_id keeping the newest "as_of" when possible.
 */
function dedupeLatestState(rows){
  const best = new Map();
  for (const r of rows || []){
    const id = r.company_id;
    if (!id) continue;
    const prev = best.get(id);
    if (!prev) { best.set(id, r); continue; }
    const a = safeText(prev.as_of);
    const b = safeText(r.as_of);
    if (b > a) best.set(id, r);
  }
  return Array.from(best.values());
}

/**
 * Pressure scoring: count conditions that are true.
 */
function pressureFromRow(r){
  const c1 = !!r.condition_1;
  const c2 = !!r.condition_2;
  const c3 = !!r.condition_3;
  const c4 = !!r.condition_4;
  return (c1?1:0)+(c2?1:0)+(c3?1:0)+(c4?1:0);
}

function stateBadge(s){
  const txt = safeText(s || "").toUpperCase();
  return `<span class="chip state">${txt || "—"}</span>`;
}

function scopeBadge(inScope){
  return inScope ? `<span class="scopeIn">IN</span>` : `<span class="scopeOut">OUT</span>`;
}

function fillStateOptions(){
  const sel = document.getElementById("stateSel");
  const seen = new Set();
  for (const r of COMPANY_ROWS){
    const s = safeText(r.state).toUpperCase();
    if (s) seen.add(s);
  }
  const all = Array.from(seen).sort();
  sel.innerHTML = `<option value="all">All states</option>` + all.map(s => `<option value="${s}">${s}</option>`).join("");
}

function applyFilters(){
  const q = document.getElementById("q").value.trim().toLowerCase();
  const scope = document.getElementById("scopeSel").value;
  const st = document.getElementById("stateSel").value;
  const sort = document.getElementById("sortSel").value;

  let rows = COMPANY_ROWS.slice();

  if (q){
    rows = rows.filter(r => {
      const c = r.company || {};
      return (
        safeText(c.name).toLowerCase().includes(q) ||
        safeText(c.ticker).toLowerCase().includes(q) ||
        safeText(c.bucket).toLowerCase().includes(q)
      );
    });
  }

  if (scope !== "all"){
    rows = rows.filter(r => scope === "in" ? !!r.company.in_scope : !r.company.in_scope);
  }

  if (st !== "all"){
    rows = rows.filter(r => safeText(r.state).toUpperCase() === st);
  }

  if (sort === "pressure_desc"){
    rows.sort((a,b) => (b.pressure - a.pressure) || safeText(a.company.ticker).localeCompare(safeText(b.company.ticker)));
  } else if (sort === "pressure_asc"){
    rows.sort((a,b) => (a.pressure - b.pressure) || safeText(a.company.ticker).localeCompare(safeText(b.company.ticker)));
  } else if (sort === "ticker"){
    rows.sort((a,b) => safeText(a.company.ticker).localeCompare(safeText(b.company.ticker)));
  } else if (sort === "company"){
    rows.sort((a,b) => safeText(a.company.name).localeCompare(safeText(b.company.name)));
  }

  renderStateTable(rows);
}

function renderEvents(){
  const body = document.getElementById("eventsBody");
  const events = (DASH && DASH.events) || [];
  if (!events.length){
    body.innerHTML = `<tr><td colspan="4" style="color:rgba(255,255,255,.45);padding:14px 12px">No state transitions recorded</td></tr>`;
    return;
  }
  const rows = events.slice(0, 25).map(e => {
    const c = COMP_BY_ID[e.company_id] || {};
    const ticker = safeText(c.ticker || e.ticker || "");
    const name = safeText(c.name || "");
    const asOf = safeText(e.as_of || "").slice(0,10) || "—";
    const trans = `${safeText(e.prev_state || "").toUpperCase()} → ${safeText(e.new_state || "").toUpperCase()}`.trim();
    return `
      <tr>
        <td><span class="chip">${ticker || "—"}</span></td>
        <td>${name || "—"}</td>
        <td>${asOf}</td>
        <td style="font-weight:700">${trans || "—"}</td>
      </tr>
    `;
  }).join("");
  body.innerHTML = rows;
}

function renderStateTable(rows){
  const body = document.getElementById("stateBody");
  if (!rows.length){
    body.innerHTML = `<tr><td colspan="13" style="color:rgba(255,255,255,.45);padding:14px 12px">No results</td></tr>`;
    return;
  }

  body.innerHTML = rows.map(r => {
    const c = r.company;
    const ticker = safeText(c.ticker);
    const name = safeText(c.name);
    const bucket = safeText(c.bucket);
    const state = safeText(r.state).toUpperCase();

    // placeholders for live quote + chart
    const priceId = `p_${ticker}`;
    const pctId = `pc_${ticker}`;
    const cvId = `cv_${ticker}`;
    const p30Id = `p30_${ticker}`;

    return `
      <tr>
        <td>${name || "—"}</td>
        <td><span class="chip">${ticker || "—"}</span></td>
        <td style="color:rgba(255,255,255,.55)">${bucket || "—"}</td>
        <td>${stateBadge(state)}</td>
        <td>${pressureBadge(r.pressure)}</td>
        <td>${cBadge(!!r.condition_1)}</td>
        <td>${cBadge(!!r.condition_2)}</td>
        <td>${cBadge(!!r.condition_3)}</td>
        <td>${cBadge(!!r.condition_4)}</td>
        <td>
          <div class="sparkWrap" title="30-day close (Yahoo)">
            <canvas class="spark" id="${cvId}" width="86" height="20"></canvas>
            <span class="sparkPct" id="${p30Id}">—</span>
          </div>
        </td>
        <td id="${priceId}" style="font-weight:800">—</td>
        <td id="${pctId}" style="font-weight:800">—</td>
        <td>${scopeBadge(!!c.in_scope)}</td>
      </tr>
    `;
  }).join("");
}

async function refreshLive(){
  // Only pull for in-scope monitor-ish rows? If you want ALL, keep this.
  const symbols = COMPANY_ROWS.map(r => r.company.ticker).filter(Boolean);

  // 1) quotes in a batch
  try{
    const q = await fetchQuotes(symbols);
    for (const sym of symbols){
      const priceEl = document.getElementById(`p_${sym}`);
      const pctEl = document.getElementById(`pc_${sym}`);
      if (!priceEl || !pctEl) continue;

      const row = q[sym];
      if (!row){
        priceEl.textContent = "—";
        pctEl.textContent = "—";
        pctEl.style.color = "";
        continue;
      }

      priceEl.textContent = fmtPrice(row.price);
      const pctText = fmtPct(row.pct);
      pctEl.textContent = pctText;
      const pctNum = Number(row.pct);
      pctEl.style.color = Number.isFinite(pctNum) ? (pctNum >= 0 ? "var(--good)" : "var(--bad)") : "";
    }
  }catch(e){
    // Do not kill the UI for quote failures
    console.warn("Quote refresh failed", e);
  }

  // 2) 30D charts per symbol (throttled a bit)
  // This is intentionally slower, to avoid hammering a proxy.
  for (const sym of symbols){
    const cv = document.getElementById(`cv_${sym}`);
    const p30 = document.getElementById(`p30_${sym}`);
    if (!cv) continue;

    try{
      const series = await fetchChart30D(sym);
      renderSpark(cv, series);

      if (p30){
        const p = pctFromSeries(series);
        p30.textContent = fmtPct(p);
        const pn = Number(p);
        p30.style.color = Number.isFinite(pn) ? (pn >= 0 ? "var(--good)" : "var(--bad)") : "";
      }
    }catch(e){
      renderSpark(cv, null);
      if (p30){
        p30.textContent = "—";
        p30.style.color = "";
      }
    }

    await new Promise(res => setTimeout(res, 120)); // gentle pacing
  }
}

async function loadDashboard(){
  const r = await fetch("./dashboard.json", { cache: "no-store" });
  if (!r.ok) throw new Error(`dashboard.json ${r.status}`);
  const dash = await r.json();
  return dash;
}

function hydrate(){
  COMP_BY_ID = buildCompanyMap(DASH);

  const latest = dedupeLatestState(DASH.latest_state || []);
  COMPANY_ROWS = latest.map(r => {
    const c = COMP_BY_ID[r.company_id] || {};
    const enriched = {
      ...r,
      company: c,
      pressure: pressureFromRow(r),
    };
    return enriched;
  });

  const tracked = (DASH.companies || []).length;
  const inScope = (DASH.companies || []).filter(c => !!c.in_scope).length;
  document.getElementById("subtitle").textContent = `Tracking ${tracked} companies (in scope: ${inScope})`;

  document.getElementById("genStamp").textContent = `Generated: ${safeText(DASH.generated_at || "--")}`;
  // If you later add a DB timestamp to dashboard.json, set it here:
  document.getElementById("dbStamp").textContent = `DB Updated: ${safeText(DASH.db_updated_at || "--")}`;

  fillStateOptions();
  renderEvents();
  applyFilters();
}

function wire(){
  ["q","scopeSel","stateSel","sortSel"].forEach(id => {
    document.getElementById(id).addEventListener("input", applyFilters);
    document.getElementById(id).addEventListener("change", applyFilters);
  });
}

(async function boot(){
  try{
    wire();
    DASH = await loadDashboard();
    hydrate();

    // initial live pull
    refreshLive();

    // refresh quotes periodically; charts less frequently because they're heavier
    setInterval(() => {
      refreshLive();
    }, 60 * 1000);
  }catch(e){
    console.error(e);
    document.getElementById("globalError").style.display = "block";
    document.getElementById("globalError").textContent = "Connection failed";
    document.getElementById("eventsBody").innerHTML = `<tr><td colspan="4" style="color:var(--bad);padding:14px 12px;font-weight:800">Failed to fetch</td></tr>`;
    document.getElementById("stateBody").innerHTML = `<tr><td colspan="13" style="color:var(--bad);padding:14px 12px;font-weight:800">Failed to fetch</td></tr>`;
  }
})();
</script>
</body>
</html>
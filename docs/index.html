<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPACShortModel</title>
    <style>
      :root{
        --bg:#f6f8fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --line:#e2e8f0;
        --shadow: 0 12px 30px rgba(2,6,23,.06);
        --radius:16px;

        --ok-bg:#ecfdf3;
        --ok-bd:#b7e3c0;
        --ok-tx:#166534;

        --bad-bg:#fff1f2;
        --bad-bd:#fecdd3;
        --bad-tx:#9f1239;

        --warn-bg:#fff7ed;
        --warn-bd:#fed7aa;
        --warn-tx:#9a3412;

        --pill-bg:#f1f5f9;
        --pill-bd:#dbe4f0;
        --pill-tx:#0f172a;

        --p0:#16a34a;
        --p1:#f59e0b;
        --p2:#f97316;
        --p3:#ef4444;
        --p4:#b91c1c;
      }

      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }

      .wrap{
        max-width: 1120px;
        margin: 0 auto;
        padding: 28px 18px 40px;
      }

      header{
        margin-bottom: 18px;
      }

      h1{
        font-size: 56px;
        line-height: 1.02;
        letter-spacing: -0.02em;
        margin: 0 0 6px;
      }

      .sub{
        color: var(--muted);
        font-size: 18px;
        margin: 0;
      }

      .grid{
        display:grid;
        grid-template-columns: 1.45fr 1fr;
        gap: 16px;
        align-items: start;
      }

      @media (max-width: 980px){
        .grid{grid-template-columns: 1fr;}
        h1{font-size: 44px;}
      }

      .card{
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow:hidden;
      }

      .card-head{
        padding: 18px 18px 10px;
        border-bottom: 1px solid var(--line);
      }

      .card-title{
        font-size: 36px;
        letter-spacing: -0.02em;
        margin: 0 0 10px;
      }

      .controls{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .control{
        display:flex;
        align-items:center;
        gap:10px;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 14px;
        background: #fff;
        min-height: 42px;
      }

      .control input, .control select{
        border:none;
        outline:none;
        font-size: 15px;
        min-width: 180px;
        background: transparent;
      }

      .control select{
        min-width: 160px;
      }

      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        letter-spacing: .02em;
        border: 1px solid var(--pill-bd);
        background: var(--pill-bg);
        color: var(--pill-tx);
        white-space: nowrap;
      }

      .chip.ok{ background: var(--ok-bg); border-color: var(--ok-bd); color: var(--ok-tx); }
      .chip.bad{ background: var(--bad-bg); border-color: var(--bad-bd); color: var(--bad-tx); }
      .chip.warn{ background: var(--warn-bg); border-color: var(--warn-bd); color: var(--warn-tx); }

      .dot{
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display:inline-block;
      }

      .meta{
        color: var(--muted);
        font-size: 13px;
        margin-left: auto;
      }

      .table-wrap{
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table{
        width: 100%;
        border-collapse: collapse;
        min-width: 980px;
      }

      th, td{
        padding: 12px 14px;
        border-bottom: 1px solid var(--line);
        vertical-align: middle;
        text-align: left;
        white-space: nowrap;
      }

      th{
        font-size: 14px;
        color: #334155;
        background: #fbfdff;
        position: sticky;
        top: 0;
        z-index: 2;
      }

      tbody tr:hover{ background: #fbfdff; }

      .ticker{
        font-weight: 900;
        letter-spacing: .02em;
      }

      .muted{ color: var(--muted); }

      .spark{
        width: 120px;
        height: 24px;
        display:block;
      }

      .spark path{
        fill: none;
        stroke: #2563eb;
        stroke-width: 2;
        opacity: .85;
      }

      .spark .baseline{
        stroke: #cbd5e1;
        stroke-width: 1;
        opacity: .8;
      }

      .priceCell{
        display:flex;
        gap:10px;
        align-items:center;
      }

      .pct{
        font-weight: 800;
        font-size: 13px;
      }

      .pct.up{ color: #166534; }
      .pct.down{ color: #9f1239; }
      .pct.flat{ color: var(--muted); }

      .small{
        font-size: 12px;
        color: var(--muted);
      }

      .note{
        padding: 14px 18px;
        color: var(--muted);
        font-size: 14px;
      }

      .footer{
        margin-top: 16px;
        padding: 14px 18px;
        border-top: 1px solid var(--line);
        background: #fbfdff;
      }

      .defs{
        display:flex;
        gap:12px;
        flex-wrap: wrap;
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .defs li{
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 14px;
        color: #0f172a;
      }

      .defs b{
        display:inline-block;
        min-width: 26px;
      }

      /* Keep the right card readable and not cut off */
      .events table{ min-width: 520px; }
      .events .table-wrap{ overflow-x:auto; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <h1>SPACShortModel</h1>
        <p class="sub" id="subtitle">Loading…</p>
      </header>

      <div class="grid">
        <section class="card">
          <div class="card-head">
            <div style="display:flex; gap:12px; align-items:baseline; flex-wrap:wrap;">
              <h2 class="card-title" style="margin:0;">Latest state</h2>
            </div>

            <div class="controls" style="margin-top:12px;">
              <div class="control">
                <span class="small">Search</span>
                <input id="q" placeholder="ticker or bucket…" />
              </div>

              <div class="control">
                <span class="small">Show</span>
                <select id="scope">
                  <option value="all">All</option>
                  <option value="in">In scope only</option>
                  <option value="out">Out of scope only</option>
                </select>
              </div>

              <div class="control">
                <span class="small">State</span>
                <select id="stateFilter">
                  <option value="all">All</option>
                </select>
              </div>

              <div class="control" style="min-width: 260px;">
                <span class="small" id="updated">Updated: —</span>
              </div>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Bucket</th>
                  <th>State</th>
                  <th>As of</th>
                  <th>Pressure</th>
                  <th>Demand/Margin</th>
                  <th>Cost/Capex</th>
                  <th>Persistence</th>
                  <th>Strategic initiatives</th>
                  <th>Price (1m)</th>
                  <th>In scope</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="footer">
            <ul class="defs">
              <li><b>C1:</b> Demand/Margin</li>
              <li><b>C2:</b> Cost/Capex</li>
              <li><b>C3:</b> Persistence</li>
              <li><b>C4:</b> “Strategic initiatives”</li>
            </ul>
            <div class="small" style="margin-top:10px;">
              Pressure is the count of triggered conditions (C1–C4). “OK” means not triggered; “FLAG” means triggered.
              Price sparkline renders only when your exporter includes 1-month closes for that ticker.
            </div>
          </div>
        </section>

        <aside class="card events">
          <div class="card-head">
            <h2 class="card-title" style="margin:0;">Recent events</h2>
            <div class="small" style="margin-top:6px;">Only state changes are logged as events.</div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Date</th>
                  <th>Change</th>
                </tr>
              </thead>
              <tbody id="events"></tbody>
            </table>
          </div>

          <div class="note" id="eventsNote"></div>
        </aside>
      </div>
    </div>

    <script>
      function safeInt(v){
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }

      function ynChip(flag){
        const on = !!flag;
        if(on){
          return `<span class="chip bad">FLAG</span>`;
        }
        return `<span class="chip ok">OK</span>`;
      }

      function pressureDot(score){
        const s = safeInt(score);
        let c = "var(--p0)";
        if(s === 1) c = "var(--p1)";
        if(s === 2) c = "var(--p2)";
        if(s === 3) c = "var(--p3)";
        if(s >= 4) c = "var(--p4)";
        return `<span class="dot" style="background:${c}"></span>`;
      }

      function pressureLabel(score){
        const s = safeInt(score);
        if(s === 0) return "Stable";
        if(s === 1) return "Watch";
        if(s === 2) return "Elevated";
        if(s === 3) return "High";
        return "Critical";
      }

      function svgSparkline(values){
        if(!Array.isArray(values) || values.length < 2) return "";
        const w = 120, h = 24, pad = 2;

        const clean = values.map(v => Number(v)).filter(v => Number.isFinite(v));
        if(clean.length < 2) return "";

        let min = Math.min(...clean);
        let max = Math.max(...clean);
        if(min === max){ min -= 1; max += 1; }

        const xStep = (w - pad*2) / (clean.length - 1);
        const y = (v) => {
          const t = (v - min) / (max - min);
          return (h - pad) - t * (h - pad*2);
        };

        let d = "";
        for(let i=0;i<clean.length;i++){
          const x = pad + i * xStep;
          const yy = y(clean[i]);
          d += (i===0 ? "M" : " L") + x.toFixed(2) + " " + yy.toFixed(2);
        }

        const baseY = y(clean[0]).toFixed(2);

        return `
          <svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
            <path class="baseline" d="M${pad} ${baseY} L${w-pad} ${baseY}"></path>
            <path d="${d}"></path>
          </svg>
        `;
      }

      function pctClass(p){
        const n = Number(p);
        if(!Number.isFinite(n)) return "flat";
        if(n > 0.25) return "up";
        if(n < -0.25) return "down";
        return "flat";
      }

      function fmtPct(p){
        const n = Number(p);
        if(!Number.isFinite(n)) return "n/a";
        const sign = n > 0 ? "+" : "";
        return `${sign}${n.toFixed(1)}%`;
      }

      // Expected optional shape in dashboard.json:
      // latest_state[i].price_1m = { closes:[...], pct_change: <number> }
      function priceCell(row){
        const p = row.price_1m;
        if(!p || !Array.isArray(p.closes) || p.closes.length < 2){
          return `<div class="priceCell"><span class="small">n/a</span></div>`;
        }
        const spark = svgSparkline(p.closes);
        const pct = fmtPct(p.pct_change);
        const cls = pctClass(p.pct_change);
        return `
          <div class="priceCell">
            ${spark}
            <span class="pct ${cls}">${pct}</span>
          </div>
        `;
      }

      function buildStateOptions(rows){
        const states = new Set(rows.map(r => String(r.state || "").trim()).filter(Boolean));
        const sel = document.getElementById("stateFilter");
        const current = sel.value || "all";
        const opts = ["all", ...Array.from(states).sort()];
        sel.innerHTML = opts.map(s => `<option value="${s}">${s === "all" ? "All" : s}</option>`).join("");
        sel.value = opts.includes(current) ? current : "all";
      }

      function normalizeData(data){
        const companiesById = new Map();
        for(const c of (data.companies || [])){
          companiesById.set(String(c.company_id), c);
        }

        const latest = (data.latest_state || []).map(ms => {
          const company = companiesById.get(String(ms.company_id)) || {};
          const inScope = !!company.in_scope;
          const c1 = !!ms.condition_1;
          const c2 = !!ms.condition_2;
          const c3 = !!ms.condition_3;
          const c4 = !!ms.condition_4;
          const pressure = [c1,c2,c3,c4].reduce((a,b)=>a+(b?1:0),0);

          return {
            company_id: ms.company_id,
            ticker: company.ticker || ms.ticker || ms.company_id,
            bucket: company.bucket || ms.bucket || "—",
            in_scope: inScope ? 1 : 0,
            as_of: ms.as_of || "",
            state: ms.state || (inScope ? "MONITOR" : "OUT_OF_SCOPE"),
            c1, c2, c3, c4,
            pressure,
            price_1m: ms.price_1m || null,
          };
        });

        // Events can be in data.events (your exporter uses "events")
        const events = (data.events || []).map(e => ({
          company_id: e.company_id,
          as_of: e.as_of,
          prev_state: e.prev_state,
          new_state: e.new_state
        }));

        return { latest, events };
      }

      function renderLatest(rows){
        const tbody = document.getElementById("rows");
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td class="ticker">${r.ticker}</td>
            <td>${r.bucket || "—"}</td>
            <td><span class="chip">${r.state}</span></td>
            <td>${r.as_of || ""}</td>
            <td>
              <span class="chip">
                ${pressureDot(r.pressure)}
                ${r.pressure} (${pressureLabel(r.pressure)})
              </span>
            </td>
            <td>${ynChip(r.c1)}</td>
            <td>${ynChip(r.c2)}</td>
            <td>${ynChip(r.c3)}</td>
            <td>${ynChip(r.c4)}</td>
            <td>${priceCell(r)}</td>
            <td>${r.in_scope}</td>
          </tr>
        `).join("");
      }

      function renderEvents(events, companiesById){
        const tbody = document.getElementById("events");
        const note = document.getElementById("eventsNote");

        if(!events.length){
          tbody.innerHTML = `
            <tr><td colspan="3" class="muted">No state-change events yet.</td></tr>
          `;
          note.textContent = "";
          return;
        }

        tbody.innerHTML = events.slice(0, 30).map(e => {
          const ticker = companiesById.get(String(e.company_id))?.ticker || e.company_id;
          return `
            <tr>
              <td class="ticker">${ticker}</td>
              <td>${e.as_of || ""}</td>
              <td><span class="chip">${e.prev_state} → ${e.new_state}</span></td>
            </tr>
          `;
        }).join("");

        note.textContent = "";
      }

      function applyFilters(allRows){
        const q = (document.getElementById("q").value || "").trim().toLowerCase();
        const scope = document.getElementById("scope").value;
        const state = document.getElementById("stateFilter").value;

        return allRows.filter(r => {
          if(scope === "in" && r.in_scope !== 1) return false;
          if(scope === "out" && r.in_scope !== 0) return false;
          if(state !== "all" && String(r.state) !== state) return false;

          if(!q) return true;
          const hay = `${r.ticker} ${r.bucket} ${r.state}`.toLowerCase();
          return hay.includes(q);
        });
      }

      async function load(){
        const res = await fetch("./dashboard.json", { cache: "no-store" });
        if(!res.ok) throw new Error(`Failed to load dashboard.json (${res.status})`);
        const data = await res.json();

        const companies = data.companies || [];
        const companiesById = new Map(companies.map(c => [String(c.company_id), c]));

        const { latest, events } = normalizeData(data);

        document.getElementById("subtitle").textContent = `Loaded ${latest.length} companies.`;
        // You currently write generated_at as a path; we still display it, but prefer a timestamp if you later change it.
        const gen = data.generated_at || "—";
        document.getElementById("updated").textContent = `Updated: ${gen}`;

        buildStateOptions(latest);

        function rerender(){
          const filtered = applyFilters(latest);
          renderLatest(filtered);
          renderEvents(events, companiesById);
        }

        document.getElementById("q").addEventListener("input", rerender);
        document.getElementById("scope").addEventListener("change", rerender);
        document.getElementById("stateFilter").addEventListener("change", rerender);

        rerender();
      }

      load().catch(err => {
        document.getElementById("subtitle").textContent = "Dashboard failed to load.";
        const tbody = document.getElementById("rows");
        tbody.innerHTML = `<tr><td colspan="11" style="color:#b91c1c; font-weight:800;">${err.message}</td></tr>`;
      });
    </script>
  </body>
</html>